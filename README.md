# Text Repository

Repository to store texts, including their metadata and versions.

Build with:
- java 11
- dropwizard
- docker

## Development

On first run:
```
docker build -t textrepo-builder -f Dockerfile.builder .
```

Build and start:
```
docker-compose up --build
```

When editing and running concordion tests, don't forget to remove its cached volume: 
```
docker volumes rmi {prefix}_concordiondata
```

### Swagger
API documentation is generated by Swagger: 
http://localhost:8080/textrepo/swagger

### Concordion
Concordion test results are served at: 
http://localhost:8080/concordion/nl/knaw/huc/textrepo/Textrepo.html

### Elasticsearch
If you run into this Elasticsearch warning:
```
max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
```

you may have to
```
sysctl -w vm.max_map_count=262144
```

(see https://github.com/docker-library/elasticsearch/issues/111)

### Kubernetes
Run:
```
kubectl apply -f kubernetes/01-postgres.yml\
 -f kubernetes/02-elasticsearch.yml\
 -f kubernetes/03-textrepo-app.yaml\
 -f kubernetes/04-nginx.yml\
 -f kubernetes/05-concordion.yml
```

## Demo

Create document from file:
```
curl -v 'localhost:8080/textrepo/files' -F contents=@{file}
```
Get file id from `Location` header or json response.
For other use cases, see Swagger documentation.

Search for latest document version of in elasticsearch index:
```
curl 'localhost:8080/index/documents/_search?q=content:{term}'
```


